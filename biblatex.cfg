\ProvidesFile{biblatex.cfg}[2024/12/18 biblatex configuration for Japanese]

% =========================
% Base style
% =========================
\RequireBibliographyStyle{phys}

% =========================
% Global biblatex options
% =========================
\ExecuteBibliographyOptions{
  abbreviate=true,
  arxiv=abs,
  backref=true,
  date=year,
  doi=true,
  eprint=true,
  giveninits=true,
  isbn=false,
  maxbibnames=3,
  maxnames=3,
  minnames=1,
  seconds=false,
  sortcites=true,
  url=false,
  urldate=iso,
  useeditor=true,
}

% =========================
% Suppress author disambiguation
% =========================
\DeclareUniquenameTemplate{
  \namepart[use=true, base=true]{prefix}
  \namepart[base=true]{family}
  \namepart[base=true]{given}
  \namepart{suffix}
}

% =========================
% Common: "in:" removal, volume format
% =========================
\renewbibmacro{in:}{}%
\DeclareFieldFormat*{volume}{\textbf{#1}\addcolon\space}

% =========================
% Non-Japanese helper (avoid redef in loops)
% =========================
\providecommand*{\mkandothers}{\mkbibemph}

% =========================
% Per-item cleanup + lang-dependent formatting
% =========================
\AtEveryBibitem{%
  % ---- Common cleanup ----
  \clearfield{note}%

  % book-specific cleanup
  \ifentrytype{book}{%
    % edition is used inside title (JP), so do not clear here if you need it.
    \clearfield{edition}%
    \clearfield{pages}%
    \clearfield{price}%
    \clearfield{condition}%
    \clearfield{timestamp}%
    \clearfield{eventdate}%
    \clearfield{keywords}%
  }{}%

  % Prefer eprint over doi/url if eprint exists
  \iffieldundef{eprint}{}{%
    \clearfield{doi}%
    \clearfield{url}%
    \clearfield{urldate}%
  }%

  % ---- Language branch (only once) ----
  \iffieldequalstr{langid}{japanese}{%
    % =========================
    % Japanese settings
    % =========================

    \DeclareNameAlias{default}{japanese}%
    \renewcommand*{\revsdnamepunct}{}%

    \DeclareDelimFormat{multinamedelim}{，}%
    \DeclareDelimFormat{finalnamedelim}{，}%
    \DeclareDelimFormat{editortypedelim}{\space}%
    \renewcommand*{\newunitpunct}{\space}%
    \renewcommand*{\labelnamepunct}{\space}%
    \renewcommand*{\finentrypunct}{\space}%

    % --- Name format: family given (and others) ---
    \DeclareNameFormat{default}{%
      \usebibmacro{name:family-given}%
        {\namepartfamily}%
        {\namepartgiven}%
        {\namepartprefix}%
        {\namepartsuffix}%
      \usebibmacro{name:andothers}%
    }%

    % --- "他" for andothers ---
    \renewbibmacro*{name:andothers}{%
      \ifboolexpr{%
        test {\ifnumequal{\value{listcount}}{\value{liststop}}}%
        and%
        test {\ifmorenames}%
      }{%
        \ifnumgreater{\value{liststop}}{1}{\finalandcomma}{}%
        \printdelim{andothersdelim}\printtext{他}%
      }{}%
    }%

    % --- author/editor logic (Japanese editor suffix "編") ---
    \renewbibmacro*{author/editor}{%
      \ifboolexpr{%
        test {\ifuseauthor}%
        and%
        not test {\ifnameundef{author}}%
      }{%
        \usebibmacro{author}%
      }{%
        \printnames{editor}%
        \setunit{\addspace}%
        \printtext{編}%
      }%
    }%

    \renewbibmacro*{author/editor+others}{%
      \ifboolexpr{%
        test {\ifuseauthor}%
        and%
        not test {\ifnameundef{author}}%
      }{%
        \usebibmacro{author}%
      }{%
        \printnames{editor}%
        \setunit{\addspace}%
        \printtext{編}%
      }%
    }%

    % --- editor string ---
    \renewbibmacro*{editor+othersstrg}{\printtext{編}}%

    % --- translator: "著（訳者訳）" ---
    \renewbibmacro*{bytranslator}{%
      \ifnameundef{translator}
        {}
        {%
          \printtext{著（}%
          \printnames[bytranslator]{translator}%
          \printtext{訳）}%
        }%
    }%
    \renewbibmacro*{bytranslator+others}{\usebibmacro{bytranslator}}%

    % --- byeditor: "編" ---
    \renewbibmacro*{byeditor}{%
      \ifnameundef{editor}
        {}
        {\printnames[byeditor]{editor}\printtext{編}}%
    }%
    \renewbibmacro*{byeditor+others}{\usebibmacro{byeditor}}%

    % --- Title / series / volume (plain formats) ---
    \DeclareFieldFormat*{title}{「#1」}%
    \DeclareFieldFormat{plainedition}{#1}%
    \DeclareFieldFormat{plainseries}{#1}%
    \DeclareFieldFormat{plainvolume}{第\textmd{#1}巻}%

    % --- book title output: 『Title[edition](series volume)』 ---
    \DeclareFieldFormat[book]{title}{%
      『#1%
        \iffieldundef{edition}{}{[\printfield[plainedition]{edition}]}%
        \iffieldundef{series}{}{%
          (\printfield[plainseries]{series}%
            \iffieldundef{volume}{}{~\printfield[plainvolume]{volume}})%
        }%
      』%
    }%

    \DeclareFieldFormat*{journaltitle}{\textmd{#1}}%
    \DeclareFieldFormat{year}{#1}%

    \renewbibmacro*{publisher+location+date}{%
      \printtext{%
        \newunit%
        (\printlist{publisher}，\printfield{year})%
        \newunit%
      }%
    }%

    % --- suppress edition/series/volume outside title for Japanese books ---
    \DeclareFieldFormat[book]{edition}{}%
    \DeclareFieldFormat[book]{series}{}%
    \DeclareFieldFormat[book]{volume}{}%

  }{%
    % =========================
    % Non-Japanese settings
    % =========================
    \DeclareFieldFormat{journaltitle}{\mkbibemph{#1}}%
    \DeclareFieldAlias{booktitle}{journaltitle}%
    
    \renewbibmacro*{name:andothers}{%
      \ifboolexpr{%
        test {\ifnumequal{\value{listcount}}{\value{liststop}}}%
        and%
        test {\ifmorenames}%
      }{%
        \ifnumgreater{\value{liststop}}{1}{\finalandcomma}{}%
        \andothersdelim\bibstring[\mkandothers]{andothers}%
      }{}%
    }%
  }%
}

\endinput