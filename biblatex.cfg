\ProvidesFile{biblatex.cfg}[2024/12/18 biblatex configuration for Japanese]
% Compatibility: some biblatex versions do not provide \ifentrylang; map it to langid.
\providecommand*{\ifentrylang}[3]{\iffieldequalstr{langid}{#1}{#2}{#3}}

% =========================
% Base style
% =========================
\RequireBibliographyStyle{phys}

% =========================
% Global biblatex options
% =========================
\ExecuteBibliographyOptions{
  abbreviate=true,
  arxiv=abs,
  backref=false,
  date=year,
  doi=false,
  eprint=true,
  giveninits=true,
  isbn=false,
  maxbibnames=99,
  maxnames=3,
  minnames=1,
    % seconds option omitted (urldate is cleared)
  sortcites=true,
  url=false,
    % urldate=iso omitted (urldate is cleared)
  useeditor=true,
}

% ------------------------------------------------------------------------------
% Biber sourcemap (INSPIRE workaround):
% If an entry has an EID (electronic/article id), INSPIRE sometimes duplicates
% the same value into "pages". In REVTeX (apsrev4-2) style, the article id
% should be printed once (as eid), and the duplicated pages should be suppressed.
% This clears "pages" only when:
%   - "eid" is present, and
%   - "pages" is a single token (no dash-range), e.g. "124" or "L45".
% ------------------------------------------------------------------------------
\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map{
      \step[fieldsource=eid, final]
      \step[fieldsource=pages, match=\regexp{^\s*[0-9A-Za-z]+\s*$}]
      \step[fieldset=pages, null]
    }
  }
}


% =========================
% Suppress author disambiguation
% =========================
\DeclareUniquenameTemplate{
  \namepart[use=true, base=true]{prefix}
  \namepart[base=true]{family}
  \namepart[base=true]{given}
  \namepart{suffix}
}

% =========================
% Common: "in:" removal, volume format
% =========================
\renewbibmacro{in:}{}%
\DeclareFieldFormat*{volume}{\mkbibbold{#1}}
\DeclareFieldFormat{number}{no.#1}
\DeclareFieldFormat{doi}{doi\addcolon\space#1}

% =========================
% Non-Japanese helper (avoid redef in loops)
% =========================
\providecommand*{\mkandothers}{\mkbibemph}

% =========================
% Per-item cleanup + lang-dependent formatting
% =========================
\AtEveryBibitem{%
  % ---- Common cleanup ----
  \clearfield{note}%

  % book-specific cleanup
  \ifentrytype{book}{%
    % edition is used inside title (JP), so do not clear here if you need it.
    \clearfield{edition}%
    \clearfield{pages}%
    \clearfield{price}%
    \clearfield{condition}%
    \clearfield{timestamp}%
    \clearfield{eventdate}%
    \clearfield{keywords}%
  }{}%

  % Prefer eprint over doi/url if eprint exists
  \iffieldundef{eprint}{}{%
    \ifentrylang{japanese}{\clearfield{doi}}{}%
    \clearfield{url}%
    \clearfield{urldate}%
  }%

  % ---- Language branch (only once) ----
  \iffieldequalstr{langid}{japanese}{%
    % =========================
    % Japanese settings
    % =========================

    \DeclareNameAlias{default}{japanese}%
    \renewcommand*{\revsdnamepunct}{}%

    \DeclareDelimFormat{multinamedelim}{，}%
    \DeclareDelimFormat{finalnamedelim}{，}%
    \DeclareDelimFormat{editortypedelim}{\space}%
    \renewcommand*{\newunitpunct}{\space}%
    \renewcommand*{\labelnamepunct}{\space}%
    \renewcommand*{\finentrypunct}{\space}%

    % --- Name format: family given (and others) ---
    \DeclareNameFormat{default}{%
      \usebibmacro{name:family-given}%
        {\namepartfamily}%
        {\namepartgiven}%
        {\namepartprefix}%
        {\namepartsuffix}%
      \usebibmacro{name:andothers}%
    }%

    % --- "他" for andothers ---
    \renewbibmacro*{name:andothers}{%
      \ifboolexpr{%
        test {\ifnumequal{\value{listcount}}{\value{liststop}}}%
        and%
        test {\ifmorenames}%
      }{%
        \ifnumgreater{\value{liststop}}{1}{\finalandcomma}{}%
        \printdelim{andothersdelim}\printtext{他}%
      }{}%
    }%

    % --- author/editor logic (Japanese editor suffix "編") ---
    \renewbibmacro*{author/editor}{%
      \ifboolexpr{%
        test {\ifuseauthor}%
        and%
        not test {\ifnameundef{author}}%
      }{%
        \usebibmacro{author}%
      }{%
        \printnames{editor}%
        \setunit{\addspace}%
        \printtext{編}%
      }%
    }%

    \renewbibmacro*{author/editor+others}{%
      \ifboolexpr{%
        test {\ifuseauthor}%
        and%
        not test {\ifnameundef{author}}%
      }{%
        \usebibmacro{author}%
      }{%
        \printnames{editor}%
        \setunit{\addspace}%
        \printtext{編}%
      }%
    }%

    % --- editor string ---
    \renewbibmacro*{editor+othersstrg}{\printtext{編}}%

    % --- translator: "著（訳者訳）" ---
    \renewbibmacro*{bytranslator}{%
      \ifnameundef{translator}
        {}
        {%
          \printtext{著（}%
          \printnames[bytranslator]{translator}%
          \printtext{訳）}%
        }%
    }%
    \renewbibmacro*{bytranslator+others}{\usebibmacro{bytranslator}}%

    % --- byeditor: "編" ---
    \renewbibmacro*{byeditor}{%
      \ifnameundef{editor}
        {}
        {\printnames[byeditor]{editor}\printtext{編}}%
    }%
    \renewbibmacro*{byeditor+others}{\usebibmacro{byeditor}}%

    % --- Title / series / volume (plain formats) ---
    \DeclareFieldFormat*{title}{「#1」}%
    \DeclareFieldFormat{plainedition}{#1}%
    \DeclareFieldFormat{plainseries}{#1}%
    \DeclareFieldFormat{plainvolume}{第\textmd{#1}巻}%

    % --- book title output: 『Title[edition](series volume)』 ---
    \DeclareFieldFormat[book]{title}{%
      『#1%
        \iffieldundef{edition}{}{[\printfield[plainedition]{edition}]}%
        \iffieldundef{series}{}{%
          (\printfield[plainseries]{series}%
            \iffieldundef{volume}{}{~\printfield[plainvolume]{volume}})%
        }%
      』%
    }%

    \DeclareFieldFormat*{journaltitle}{\textmd{#1}}%
    \DeclareFieldFormat{year}{#1}%

    \renewbibmacro*{publisher+location+date}{%
      \printtext{%
        \newunit%
        (\printlist{publisher}，\printfield{year})%
        \newunit%
      }%
    }%

    % --- suppress edition/series/volume outside title for Japanese books ---
    \DeclareFieldFormat[book]{edition}{}%
    \DeclareFieldFormat[book]{series}{}%
    \DeclareFieldFormat[book]{volume}{}%

  }{%
    % =========================
    % Non-Japanese settings
    % =========================
    \DeclareFieldFormat{journaltitle}{\mkbibemph{#1}}%
    \DeclareFieldFormat[article]{title}{\mkbibquote{#1}}% REVTeX: title in quotes, no italics
    % --- REVTeX/apsrev4-2-like (English) bibliography formatting ---
    \DeclareNameAlias{default}{given-family}% "C. Tian" (not "Tian, C.")
    \DeclareDelimFormat{multinamedelim}{\addcomma\space}%
    \DeclareDelimFormat{finalnamedelim}{\addspace and\space}%
    \DeclareDelimFormat{andothersdelim}{\addcomma\space}%
    \renewcommand*{\finalandcomma}{}%
    \renewcommand*{\labelnamepunct}{\addcomma\space}%
    \renewcommand*{\bibinitdelim}{\addnbspace}%
    \renewcommand*{\bibnamedelima}{\addnbspace}%
    \renewcommand*{\bibnamedelimb}{\addnbspace}%
    \renewcommand*{\bibnamedelimc}{\addnbspace}%
    \renewcommand*{\bibnamedelimd}{\addnbspace}%

    % Volume + EID (article number). Issue numbers are typically omitted in APS refs.
    \renewbibmacro*{volume+number+eid}{%
  \printfield{volume}%
  \iffieldundef{number}{}{%
    \setunit{\addcomma\space}%
    \printfield{number}%
  }%
  \iffieldundef{eid}{}{%
    \setunit{\addcomma\space}%
    \printfield{eid}%
  }%
}
}% end of language-specific \ifboolexpr
}% end of \AtEveryBibitem


\endinput